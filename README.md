Этот репозиторий содержит списки доменов, недоступных в РФ. Он основан на работе проекта [Re-filter-lists](https://github.com/1andrevich/Re-filter-lists/tree/main) и дополнен собственным списком доменов, которые либо не попали в другие списки, либо были заблокированы для доступа из РФ, но не внесены в реестр РКН.

## Источники данных

Основной список доменов берется из репозитория [Re-filter-lists](https://github.com/1andrevich/Re-filter-lists/tree/main), который описан в статье на Хабре: [Создаем свой список блокировок сайтов (DNS)](https://habr.com/ru/articles/850292/). Этот проект предоставляет обширный список доменов, что значительно упрощает задачу.

Репозиторий содержит личный список доменов (`src/domains.lst`), который формируется вручную на основе личных наблюдений, сообщений других пользователей и других источников. Этот список содержит сайты, которые:

*   Отсутствуют в списке Re-filter-lists.
*   Ограничили доступ для пользователей из РФ, но не заблокированы РКН.

## Скрипты

### `convert.py`

Скрипт используется для автоматического обновления и объединения списков. Он запускается автоматически раз в три дня посредством GitHub Actions (конфигурация в `.github/workflows/create-lists.yml`).

**Алгоритм работы скрипта:**

1.  **Загрузка (download_file):** Загружает актуальный список доменов из репозитория Re-filter-lists (`domains_all.lst`) по указанному URL. Функция `download_file(url, output_file)` реализует эту операцию, сохраняя скачанный файл по заданному пути. В случае ошибки скачивания, скрипт завершает работу.
2.  **Фильтрация (filter_domains):** Обрабатывает скачанный список, удаляя домены `.ua`, зеркала (оставляя только основной домен) и записи `www.` При обработке дубликатов приоритет отдается доменам без префикса `www` и цифровых префиксов, в противном случае выбирается самый короткий домен из группы. Для корректного извлечения домена верхнего уровня используется библиотека `tldextract`. Функция `filter_domains(input_file, output_file)` принимает на вход и выход пути к файлам, выполняя непосредственно фильтрацию.
3.  **Объединение (combine_files):** Отфильтрованный список объединяется со своим личным списком (`src/domains.lst`) Объединение производится с удалением дубликатов, формируя итоговый список `all_domains.lst`. Функция `combine_files(input_files, output_file)` принимает список входных файлов и путь к выходному файлу, выполняя операцию объединения. В случае отсутствия одного из входных файлов выводится предупреждение, но выполнение скрипта не прерывается.
4.  **Генерация dnsmasq-nfset (generate_dnsmasq):** На основе итогового списка `all_domains.lst` формируется файл `dnsmasq-nfset.lst`, содержащий правила для использования в конфигурации `dnsmasq` совместно с `nftset`. Каждая строка в выходном файле имеет формат `nftset=/{domain}/4#inet#fw4#vpn_domains\n`, что соответствует правилу nftset для IPv4. Функция `generate_dnsmasq(input_file, output_file)` принимает пути к файлам и генерирует конфигурацию. Строки, начинающиеся с `#`, игнорируются как комментарии.
5.  **Очистка (cleanup_temp_files):** удаляются временные файлы, созданные в процессе работы скрипта. Функция `cleanup_temp_files(*files)` принимает переменное число аргументов, представляющих собой пути к файлам для удаления. Обработка исключения `FileNotFoundError` позволяет избежать ошибок в случае отсутствия какого-либо из временных файлов.

### `domain_cleaner.py`

Этот скрипт предназначен для очистки и подготовки личного списка доменов (`src/domains.lst`). Он позволяет:

*   Удалять дубликаты.
*   Удалять домены `.ua`.
*   Удалять записи `www.`.
*   Группировать зеркала и оставлять только основной домен.

Этот скрипт используется локально для ручной обработки личного списка доменов. Подробное описание его функциональности необходимо добавить отдельно в README.md после его написания.

## Использование в OpenWrt

Итоговые файлы `all_domains.lst` и `dnsmasq-nfset.lst`. Файл `dnsmasq-nfset.lst` предназначен для использования в OpenWrt, содержит готовые правила для блокировки доменов с помощью `dnsmasq` и `nftset`. Инструкция по настройке OpenWrt с использованием этих файлов будет добавлена позже. На данный момент реализована поддержка IPv4, но предусмотрена возможность добавления IPv6 (соответствующая строка закомментирована в скрипте `convert.py`).

инструкция по настройке OpenWrt будут добавлены в будущем.
