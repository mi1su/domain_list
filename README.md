Этот репозиторий содержит списки доменов, недоступных в РФ. Он основан на работе проекта [Re-filter-lists](https://github.com/1andrevich/Re-filter-lists/tree/main) и дополнен собственным списком доменов, которые либо не попали в другие списки, либо были заблокированы для доступа из РФ, но не внесены в реестр РКН.

## Источники данных

Основной список доменов берется из репозитория [Re-filter-lists](https://github.com/1andrevich/Re-filter-lists/tree/main), который описан в статье на Хабре: [Создаем свой список блокировок сайтов (DNS)](https://habr.com/ru/articles/850292/). Этот проект предоставляет обширный список доменов, что значительно упрощает задачу.

Репозиторий содержит личный список доменов (`src/domains.lst`), который формируется вручную на основе личных наблюдений, сообщений других пользователей и других источников. Этот список содержит сайты, которые:

*   Отсутствуют в списке Re-filter-lists.
*   Ограничили доступ для пользователей из РФ, но не заблокированы РКН.

## Скрипты

### `domains.py`

Скрипт используется для автоматического обновления и объединения списков доменов. Он запускается автоматически раз в три дня посредством GitHub Actions (конфигурация в `.github/workflows/create-lists.yml`).

**Алгоритм работы скрипта:**

1.  **Загрузка (download_domains):** Загружает актуальный список доменов из репозитория Re-filter-lists по указанному URL. Функция `download_domains(url)` реализует эту операцию, возвращая список доменов. В случае ошибки скачивания, скрипт завершает работу.
2. **Чтение локального списка (read_local_domains):** Читает список доменов из локального файла. Функция `read_local_domains(file_path)` возвращает список доменов, прочитанных из файла. В случае отсутствия файла или ошибки чтения, скрипт завершает работу.
3. **Фильтрация поддоменов (filter_subdomains):** Фильтрует поддомены верхнего уровня (TLD) и оставляет только один из группы похожих доменов. Функция `filter_subdomains(domains)` принимает список доменов и возвращает отфильтрованный список.

4. **Очистка доменов (clear_domain):** Обрабатывает "зеркала" доменов, оставляя только один из похожих. Функция `clear_domain(domains)` принимает список доменов и возвращает уникальные домены.

5. **Объединение списков (merge_lists):** Объединяет удаленный и локальный списки доменов и фильтрует дубликаты. Функция `merge_lists(remote_domains, local_domains)` принимает два списка доменов и возвращает объединенный и отфильтрованный список.

6. **Сохранение объединенного списка (save_merged_list):** Сохраняет объединенный список доменов в файл. Функция `save_merged_list(merged_domains, output_file)` принимает список доменов и путь к выходному файлу.

7. **Генерация dnsmasq-nfset в формате nftset (save_nftset_list):** Сохраняет список доменов в формате nftset для использования в конфигурации `nftables`. Функция `save_nftset_list(merged_domains, nfset_file)` принимает список доменов и путь к выходному файлу. Каждая строка в выходном файле имеет формат `nftset=/{domain}/4#inet#fw4#vpn_domains\n`, что соответствует правилу nftset для IPv4.

8. **Основная функция (main):** Координирует выполнение всех шагов, загружая, читая, фильтруя, объединяя и сохраняя списки доменов. В случае ошибки на любом этапе, скрипт выводит сообщение об ошибке и продолжает выполнение.

### `domain_cleaner.py`

Этот скрипт предназначен для очистки и подготовки личного списка доменов (`src/domains.lst`). Он позволяет:

*   Удалять дубликаты.
*   Удалять домены `.ua`.
*   Удалять записи `www.`.
*   Группировать зеркала и оставлять только основной домен.

Этот скрипт используется локально для ручной обработки личного списка доменов. Подробное описание его функциональности необходимо добавить отдельно в README.md после его написания.

## Использование в OpenWrt

Итоговые файлы `all_domains.lst` и `dnsmasq-nfset.lst`. Файл `dnsmasq-nfset.lst` предназначен для использования в OpenWrt, содержит готовые правила для блокировки доменов с помощью `dnsmasq` и `nftset`. Инструкция по настройке OpenWrt с использованием этих файлов будет добавлена позже. На данный момент реализована поддержка IPv4, но предусмотрена возможность добавления IPv6 (соответствующая строка закомментирована в скрипте `domains.py`).

инструкция по настройке OpenWrt будут добавлены в будущем.
